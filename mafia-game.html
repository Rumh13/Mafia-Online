<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø§ÙÙŠØ§ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 700px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #ff9a3c;
        }
        
        .screen {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #ff9a3c;
        }
        
        input, button, select {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        input, select {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            text-align: center;
            border: 2px solid transparent;
        }
        
        input:focus, select:focus {
            border-color: #ff9a3c;
            outline: none;
        }
        
        button {
            background: #ff9a3c;
            color: #1a1a2e;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #ff7b00;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
            width: auto;
        }
        
        .room-code {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 25px 0;
            font-size: 32px;
            font-weight: bold;
            border: 2px solid #ff9a3c;
        }
        
        .players-list {
            margin: 25px 0;
        }
        
        .player-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
            border: 2px solid transparent;
        }
        
        .player-card.you {
            border-color: #ff9a3c;
            background: rgba(255, 155, 60, 0.2);
        }
        
        .player-card.host::after {
            content: " ğŸ‘‘";
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            line-height: 1.6;
        }
        
        .link-box {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .link-box input {
            background: transparent;
            border: none;
            color: #333;
            font-weight: bold;
        }
        
        .game-info {
            text-align: center;
            margin: 15px 0;
            font-size: 18px;
            color: #ff9a3c;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .rooms-list {
            margin: 20px 0;
        }
        
        .room-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .room-item:hover {
            border-color: #ff9a3c;
            background: rgba(255, 155, 60, 0.1);
        }
        
        .room-info {
            flex-grow: 1;
        }
        
        .room-name {
            font-weight: bold;
            font-size: 18px;
            color: #ff9a3c;
        }
        
        .room-details {
            font-size: 14px;
            color: #ccc;
        }
        
        .refresh-btn {
            background: #2ed573;
            margin-bottom: 15px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 1: Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div class="screen active" id="screen1">
            <h1>ğŸ® Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø§ÙÙŠØ§</h1>
            
            <div class="instructions">
                <h3>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù„Ø¹Ø¨:</h3>
                <p>â€¢ Ø§Ø®ØªØ± Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø©</p>
                <p>â€¢ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ³Ù…ÙŠØ© Ø§Ù„ØºØ±ÙØ© Ø¨Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…ÙØ¶Ù„</p>
                <p>â€¢ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ†Ø¶Ù… 4-6 Ù„Ø§Ø¹Ø¨ÙŠÙ†</p>
            </div>
            
            <div class="input-group">
                <label for="playerName">Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨:</label>
                <input type="text" id="playerName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" maxlength="15">
            </div>
            
            <button onclick="showScreen('screen2')">ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
            <button onclick="showRoomsScreen()">ğŸ”— Ø¹Ø±Ø¶ Ø§Ù„ØºØ±Ù Ø§Ù„Ù…ØªØ§Ø­Ø©</button>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 2: Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø© -->
        <div class="screen" id="screen2">
            <h1>ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h1>
            
            <div class="input-group">
                <label for="createPlayerName">Ø§Ø³Ù…Ùƒ:</label>
                <input type="text" id="createPlayerName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ">
            </div>
            
            <div class="input-group">
                <label for="roomName">Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©:</label>
                <input type="text" id="roomName" placeholder="Ø§Ø®ØªØ± Ø§Ø³Ù… Ù„Ù„ØºØ±ÙØ© (Ù…Ø«Ø§Ù„: ØºØ±ÙØ© Ø£Ø­Ù…Ø¯)" maxlength="20">
            </div>
            
            <button onclick="createRoom()">âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©</button>
            <button onclick="showScreen('screen1')">â†© Ø±Ø¬ÙˆØ¹</button>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 3: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØºØ±Ù Ø§Ù„Ù…ØªØ§Ø­Ø© -->
        <div class="screen" id="screen3">
            <h1>ğŸ  Ø§Ù„ØºØ±Ù Ø§Ù„Ù…ØªØ§Ø­Ø©</h1>
            
            <button onclick="loadRooms()" class="refresh-btn">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
            
            <div class="rooms-list" id="roomsList">
                <div class="empty-state">
                    ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù...
                </div>
            </div>
            
            <button onclick="showScreen('screen1')">â†© Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 4: Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© -->
        <div class="screen" id="screen4">
            <h1>ğŸ”— Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ©</h1>
            
            <div class="input-group">
                <label for="joinPlayerName">Ø§Ø³Ù…Ùƒ:</label>
                <input type="text" id="joinPlayerName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ">
            </div>
            
            <div class="input-group">
                <label for="roomCodeInput">ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©:</label>
                <input type="text" id="roomCodeInput" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©" maxlength="6">
            </div>
            
            <button onclick="joinRoom()">ğŸšª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</button>
            <button onclick="showScreen('screen1')">â†© Ø±Ø¬ÙˆØ¹</button>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 5: ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨ -->
        <div class="screen" id="screen5">
            <h1>ğŸ‘¥ ØºØ±ÙØ© Ø§Ù„Ù„Ø¹Ø¨</h1>
            
            <div class="room-code">
                ğŸ  <span id="roomNameDisplay">ØºØ±ÙØ©</span>
                <br>
                <small>ÙƒÙˆØ¯: <span id="roomCodeDisplay">----</span></small>
            </div>
            
            <div class="instructions">
                <h3>ğŸ“¤ Ø´Ø§Ø±Ùƒ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©:</h3>
                <div class="link-box">
                    <input type="text" id="roomCodeShare" readonly>
                    <button onclick="copyRoomCode()" style="background: #2ed573;">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯</button>
                </div>
                <p>Ø£Ø¹Ø·Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù„Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: <strong id="roomCodeText">----</strong></p>
            </div>

            <div class="game-info">
                ğŸ‘¥ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†: <span id="playersCount">1</span>/6
            </div>
            
            <div class="status" id="connectionStatus">
                ğŸ”„ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...
            </div>
            
            <div class="players-list" id="playersList">
                <div class="player-card you" id="currentPlayerDisplay">
                    Ø£Ù†Øª (Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...)
                </div>
            </div>

            <button onclick="startGame()" id="startGameBtn" disabled>ğŸ¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
            <button onclick="leaveRoom()" style="background: #ff4757;">ğŸšª Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©</button>
        </div>

        <!-- Ø§Ù„Ø´Ø§Ø´Ø© 6: Ø§Ù„Ù„Ø¹Ø¨Ø© -->
        <div class="screen" id="screen6">
            <h1>ğŸ­ Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…Ø§ÙÙŠØ§</h1>
            <div id="gameContent"></div>
            <button onclick="showScreen('screen5')">â†© Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØºØ±ÙØ©</button>
        </div>
    </div>

    <!-- Ø¥Ø¶Ø§ÙØ© Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // ğŸ”¥ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase - Ø§Ø³ØªØ®Ø¯Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ
        const firebaseConfig = {
            apiKey: "AIzaSyDFDkcVlW_S0hFE7-r9Cp8j3TAfKJHmGwY",
            authDomain: "mafya-583f3.firebaseapp.com",
            projectId: "mafya-583f3",
            storageBucket: "mafya-583f3.firebasestorage.app",
            messagingSenderId: "878013364716",
            appId: "1:878013364716:web:716ce5f1644e5e6d73e8c9"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        let gameData = {
            players: [],
            currentPlayer: null,
            roomCode: null,
            roomName: '',
            roomRef: null,
            unsubscribe: null,
            roomsUnsubscribe: null
        };

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        function updateConnectionStatus(message, isError = false) {
            const status = document.getElementById('connectionStatus');
            status.textContent = message;
            status.style.background = isError ? 'rgba(255, 71, 87, 0.3)' : 'rgba(46, 213, 115, 0.3)';
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø§Ø´Ø©
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØºØ±Ù
        function showRoomsScreen() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            document.getElementById('joinPlayerName').value = playerName;
            showScreen('screen3');
            loadRooms();
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù Ø§Ù„Ù…ØªØ§Ø­Ø©
        function loadRooms() {
            const roomsList = document.getElementById('roomsList');
            roomsList.innerHTML = '<div class="empty-state">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØºØ±Ù...</div>';

            // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (gameData.roomsUnsubscribe) {
                gameData.roomsUnsubscribe();
            }

            // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØºØ±Ù
            gameData.roomsUnsubscribe = db.collection('rooms')
                .where('gameState', '==', 'waiting')
                .onSnapshot((snapshot) => {
                    const rooms = [];
                    snapshot.forEach((doc) => {
                        const roomData = doc.data();
                        if (roomData.players.length < 6) { // ÙÙ‚Ø· Ø§Ù„ØºØ±Ù ØºÙŠØ± Ø§Ù„Ù…Ù…ØªÙ„Ø¦Ø©
                            rooms.push({
                                id: doc.id,
                                ...roomData
                            });
                        }
                    });

                    displayRooms(rooms);
                }, (error) => {
                    console.error('Error loading rooms:', error);
                    roomsList.innerHTML = '<div class="empty-state">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØºØ±Ù</div>';
                });
        }

        // Ø¹Ø±Ø¶ Ø§Ù„ØºØ±Ù ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        function displayRooms(rooms) {
            const roomsList = document.getElementById('roomsList');
            
            if (rooms.length === 0) {
                roomsList.innerHTML = `
                    <div class="empty-state">
                        ğŸ  Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ±Ù Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹
                        <br>
                        <small>ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©!</small>
                    </div>
                `;
                return;
            }

            roomsList.innerHTML = '';
            rooms.forEach(room => {
                const roomItem = document.createElement('div');
                roomItem.className = 'room-item';
                
                const hostPlayer = room.players.find(p => p.id === room.host);
                const hostName = hostPlayer ? hostPlayer.name : 'Ù…Ø¬Ù‡ÙˆÙ„';
                
                roomItem.innerHTML = `
                    <div class="room-info">
                        <div class="room-name">${room.roomName || 'ØºØ±ÙØ© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</div>
                        <div class="room-details">
                            Ø§Ù„Ù…Ø¶ÙŠÙ: ${hostName} | Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: ${room.players.length}/6
                        </div>
                    </div>
                    <button class="btn-small" onclick="joinRoomById('${room.id}')">
                        Ø§Ù†Ø¶Ù… âœ…
                    </button>
                `;
                
                roomsList.appendChild(roomItem);
            });
        }

        // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        function joinRoomById(roomId) {
            const playerName = document.getElementById('joinPlayerName').value.trim();
            if (!playerName) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ');
                return;
            }

            gameData.roomCode = roomId;
            joinRoom();
        }

        // Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
        async function createRoom() {
            const playerName = document.getElementById('createPlayerName').value.trim();
            const roomName = document.getElementById('roomName').value.trim();
            
            if (!playerName) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ');
                return;
            }

            if (!roomName) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ù„ØºØ±ÙØ©');
                return;
            }

            const playerId = generateId();
            gameData.currentPlayer = {
                id: playerId,
                name: playerName,
                isHost: true,
                joinedAt: new Date().toISOString()
            };

            gameData.roomCode = generateRoomCode();
            gameData.roomName = roomName;
            
            try {
                gameData.roomRef = db.collection('rooms').doc(gameData.roomCode);
                
                await gameData.roomRef.set({
                    code: gameData.roomCode,
                    roomName: roomName,
                    host: playerId,
                    players: [gameData.currentPlayer],
                    gameState: 'waiting',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                setupRoomListener();
                showRoomScreen();
                updateConnectionStatus('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© Ø¨Ù†Ø¬Ø§Ø­');
                
            } catch (error) {
                console.error('Error creating room:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©: ' + error.message);
            }
        }

        // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø©
        async function joinRoom() {
            const playerName = document.getElementById('joinPlayerName').value.trim();
            let roomCode = gameData.roomCode;
            
            if (!roomCode) {
                roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            }
            
            if (!playerName) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ');
                return;
            }
            
            if (!roomCode) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©');
                return;
            }

            const playerId = generateId();
            gameData.currentPlayer = {
                id: playerId,
                name: playerName,
                isHost: false,
                joinedAt: new Date().toISOString()
            };

            gameData.roomCode = roomCode;
            
            try {
                gameData.roomRef = db.collection('rooms').doc(roomCode);
                const roomDoc = await gameData.roomRef.get();
                
                if (!roomDoc.exists) {
                    alert('âŒ Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©! ØªØ£ÙƒØ¯ Ù…Ù† ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©');
                    return;
                }

                const roomData = roomDoc.data();
                if (roomData.players.length >= 6) {
                    alert('âŒ Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©! Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 6 Ù„Ø§Ø¹Ø¨ÙŠÙ†');
                    return;
                }

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù„Ø§Ø¹Ø¨ Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù…
                const existingPlayer = roomData.players.find(p => p.name === playerName);
                if (existingPlayer) {
                    alert('âŒ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø± Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©!');
                    return;
                }

                await gameData.roomRef.update({
                    players: firebase.firestore.FieldValue.arrayUnion(gameData.currentPlayer)
                });

                gameData.roomName = roomData.roomName || 'ØºØ±ÙØ© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
                setupRoomListener();
                showRoomScreen();
                updateConnectionStatus('âœ… ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© Ø¨Ù†Ø¬Ø§Ø­');
                
            } catch (error) {
                console.error('Error joining room:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©: ' + error.message);
            }
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
        function setupRoomListener() {
            gameData.unsubscribe = gameData.roomRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const roomData = doc.data();
                    gameData.players = roomData.players || [];
                    gameData.roomName = roomData.roomName || 'ØºØ±ÙØ© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
                    updateRoomDisplay(roomData);
                }
            }, (error) => {
                console.error('Room listener error:', error);
                updateConnectionStatus('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', true);
            });
        }

        // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØºØ±ÙØ©
        function showRoomScreen() {
            document.getElementById('roomCodeDisplay').textContent = gameData.roomCode;
            document.getElementById('roomNameDisplay').textContent = gameData.roomName;
            document.getElementById('roomCodeShare').value = gameData.roomCode;
            document.getElementById('roomCodeText').textContent = gameData.roomCode;
            document.getElementById('currentPlayerDisplay').textContent = `${gameData.currentPlayer.name} (Ø£Ù†Øª)`;
            
            showScreen('screen5');
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ØºØ±ÙØ©
        function updateRoomDisplay(roomData) {
            const playersList = document.getElementById('playersList');
            const playersCount = document.getElementById('playersCount');
            const startBtn = document.getElementById('startGameBtn');
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
            playersCount.textContent = gameData.players.length;
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
            playersList.innerHTML = '';
            gameData.players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = `player-card ${player.id === gameData.currentPlayer.id ? 'you' : ''} ${player.id === roomData.host ? 'host' : ''}`;
                
                let playerInfo = player.name;
                if (player.id === gameData.currentPlayer.id) {
                    playerInfo += ' (Ø£Ù†Øª)';
                }
                if (player.id === roomData.host) {
                    playerInfo += ' ğŸ‘‘';
                }
                
                playerDiv.textContent = playerInfo;
                playersList.appendChild(playerDiv);
            });

            // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ (Ù„Ù„Ù…Ø¶ÙŠÙ ÙÙ‚Ø·)
            if (gameData.currentPlayer.id === roomData.host) {
                if (gameData.players.length >= 4) {
                    startBtn.disabled = false;
                    startBtn.textContent = `ğŸ¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© (${gameData.players.length}/6)`;
                    updateConnectionStatus(`âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø¯Ø¡ (${gameData.players.length} Ù„Ø§Ø¹Ø¨ÙŠÙ†)`);
                } else {
                    startBtn.disabled = true;
                    startBtn.textContent = `â³ Ø§Ù†ØªØ¸Ø± Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¢Ø®Ø±ÙŠÙ† (${gameData.players.length}/4)`;
                    updateConnectionStatus(`ğŸ”„ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†... (${gameData.players.length}/4)`);
                }
            } else {
                startBtn.style.display = 'none';
                updateConnectionStatus(`ğŸ”„ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©... (${gameData.players.length}/4)`);
            }
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        async function startGame() {
            if (gameData.players.length < 4) {
                alert('ÙŠØ­ØªØ§Ø¬ 4 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©');
                return;
            }

            try {
                // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
                const roles = distributeRoles(gameData.players.length);
                const playersWithRoles = gameData.players.map((player, index) => ({
                    ...player,
                    role: roles[index]
                }));

                await gameData.roomRef.update({
                    players: playersWithRoles,
                    gameState: 'playing'
                });

                showScreen('screen6');
                showGameRoles(playersWithRoles);
                
            } catch (error) {
                console.error('Error starting game:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©');
            }
        }

        // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
        function distributeRoles(playerCount) {
            const configs = {
                4: ['mafia', 'citizen', 'doctor', 'elder'],
                5: ['mafia', 'mafia', 'citizen', 'doctor', 'elder'],
                6: ['mafia', 'mafia', 'citizen', 'citizen', 'doctor', 'elder']
            };
            
            const roles = configs[playerCount] || configs[4];
            return shuffleArray([...roles]);
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©
        function showGameRoles(playersWithRoles) {
            const gameContent = document.getElementById('gameContent');
            let html = '<div class="instructions">';
            
            const currentPlayer = playersWithRoles.find(p => p.id === gameData.currentPlayer.id);
            
            if (currentPlayer) {
                html += `<div class="player-card you" style="font-size: 20px; margin: 20px 0;">
                    <h2>ğŸ¯ Ø¯ÙˆØ±Ùƒ: ${getRoleName(currentPlayer.role)}</h2>
                    <p>${getRoleDescription(currentPlayer.role)}</p>
                </div>`;
            }
            
            html += '<h3>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:</h3>';
            playersWithRoles.forEach(player => {
                html += `<div class="player-card ${player.id === gameData.currentPlayer.id ? 'you' : ''}">
                    ${player.name} ${player.id === gameData.currentPlayer.id ? '(Ø£Ù†Øª)' : ''}
                    <br><small>Ø§Ù„Ø¯ÙˆØ±: ${player.id === gameData.currentPlayer.id ? getRoleName(player.role) : '???'}</small>
                </div>`;
            });
            
            html += '</div>';
            gameContent.innerHTML = html;
        }

        // Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©
        function copyRoomCode() {
            const codeInput = document.getElementById('roomCodeShare');
            codeInput.select();
            navigator.clipboard.writeText(codeInput.value);
            alert('âœ… ØªÙ… Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©: ' + gameData.roomCode);
        }

        // Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©
        async function leaveRoom() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©ØŸ')) {
                if (gameData.unsubscribe) {
                    gameData.unsubscribe();
                }
                
                if (gameData.roomsUnsubscribe) {
                    gameData.roomsUnsubscribe();
                }
                
                if (gameData.roomRef && gameData.currentPlayer) {
                    try {
                        await gameData.roomRef.update({
                            players: firebase.firestore.FieldValue.arrayRemove(gameData.currentPlayer)
                        });
                    } catch (error) {
                        console.error('Error leaving room:', error);
                    }
                }
                
                gameData.players = [];
                gameData.currentPlayer = null;
                gameData.roomRef = null;
                
                showScreen('screen1');
            }
        }

        // ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø©
        function getRoleName(role) {
            const roleNames = {
                mafia: 'Ù…Ø§ÙÙŠØ§ ğŸ—¡ï¸',
                citizen: 'Ù…ÙˆØ§Ø·Ù† ğŸ‘¨â€ğŸŒ¾',
                doctor: 'Ø¯ÙƒØªÙˆØ± ğŸ¥',
                elder: 'Ø´Ø§ÙŠØ¨ ğŸ§“'
            };
            return roleNames[role] || role;
        }

        function getRoleDescription(role) {
            const descriptions = {
                mafia: 'Ø£Ù†Øª Ù…Ù† Ø§Ù„Ù…Ø§ÙÙŠØ§! Ù‚Ù… Ø¨Ù‚ØªÙ„ Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ† Ù„ÙŠÙ„Ø§Ù‹.',
                citizen: 'Ø£Ù†Øª Ù…ÙˆØ§Ø·Ù†! Ø­Ø§ÙˆÙ„ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…Ø§ÙÙŠØ§.',
                doctor: 'Ø£Ù†Øª Ø§Ù„Ø¯ÙƒØªÙˆØ±! ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ù‚Ø§Ø° Ø´Ø®Øµ Ù…Ù† Ø§Ù„Ù‚ØªÙ„.',
                elder: 'Ø£Ù†Øª Ø§Ù„Ø´Ø§ÙŠØ¨! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù‡ÙˆÙŠØ© Ù„Ø§Ø¹Ø¨.'
            };
            return descriptions[role] || '';
        }

        function generateId() {
            return Math.random().toString(36).substring(2, 15);
        }

        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ
        window.addEventListener('load', function() {
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©
            const savedName = localStorage.getItem('playerName');
            if (savedName) {
                document.getElementById('playerName').value = savedName;
                document.getElementById('createPlayerName').value = savedName;
                document.getElementById('joinPlayerName').value = savedName;
            }
            
            // Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø©
            document.getElementById('playerName').addEventListener('input', function() {
                localStorage.setItem('playerName', this.value);
                document.getElementById('createPlayerName').value = this.value;
                document.getElementById('joinPlayerName').value = this.value;
            });
        });
    </script>
</body>
</html>
